<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>Coordinator Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
<div th:replace="fragments/header :: header"></div>
<span id="currentUserName" th:text="${currentUserName}" class="d-none"></span>
<div class="container mt-4">
    <h1>Coordinator Dashboard</h1>

    <div class="card mb-4">
        <div class="card-header">Project Report Deadline</div>
        <div class="card-body">
            <form method="post" th:action="@{/coordinator/set-deadline}" class="row g-3 align-items-end">
                <div class="col-auto">
                    <label for="deadline" class="form-label">Set Deadline</label>
                    <input type="datetime-local" class="form-control" id="deadline" name="deadline" required>
                </div>
                <div class="col-auto">
                    <button type="submit" class="btn btn-primary">Set Deadline</button>
                </div>
            </form>
            <div class="mt-2">
                <strong>Current deadline: </strong>
                <span th:if="${currentDeadline != null}" th:text="${#temporals.format(currentDeadline, 'EEEE, MMMM d, yyyy ''at'' h:mm a')}"></span>
                <span th:if="${currentDeadline == null}">No deadline set</span>
            </div>
        </div>
    </div>

    <h2 class="mt-3">Student Project Application Reminders</h2>
    <p class="text-muted">Search students and send reminders. Default view shows unassigned students. Select students below to include in the reminder.</p>

    <form method="get" th:action="@{/coordinator}" class="row g-3 align-items-end mb-4">
        <div class="col-md-3">
            <label class="form-label" for="statusSelect">Project Status</label>
            <select class="form-select" id="statusSelect" name="status">
                <option value="ALL" th:selected="${selectedStatus == 'ALL'}">All</option>
                <option value="ASSIGNED" th:selected="${selectedStatus == 'ASSIGNED'}">Assigned</option>
                <option value="UNASSIGNED" th:selected="${selectedStatus == 'UNASSIGNED'}">Unassigned</option>
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label" for="programSelect">Program</label>
            <select class="form-select" id="programSelect" name="program">
                <option value="" th:selected="${selectedProgram == null || selectedProgram == ''}">All</option>
                <option th:each="p : ${programs}" th:value="${p}" th:text="${p}" th:selected="${p.name() == selectedProgram}"></option>
            </select>
        </div>
        <div class="col-md-4">
            <label class="form-label" for="projectSelect">Project Name</label>
            <select class="form-select" id="projectSelect" name="projectId">
                <option value="" th:selected="${selectedProjectId == null}">All</option>
                <option th:each="proj : ${projects}" th:value="${proj.id}" th:text="${proj.title}" th:selected="${proj.id == selectedProjectId}"></option>
            </select>
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-primary w-100">Search</button>
        </div>
    </form>

    <div th:if="${reminderError}" class="alert alert-danger" th:text="${reminderError}"></div>

    <form method="post" th:action="@{/coordinator/reminder}" id="reminderForm">
        <div class="mb-2 d-flex flex-wrap gap-2">
            <button type="button" class="btn btn-secondary btn-sm" onclick="selectAll(true)">Select All</button>
            <button type="button" class="btn btn-secondary btn-sm" onclick="selectAll(false)">Deselect All</button>
            <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#reminderModal" onclick="prepareReminderModal()">Create Reminder Message</button>
        </div>
        <table class="table table-striped table-hover mt-2">
            <thead>
            <tr>
                <th></th>
                <th>Name</th>
                <th>Student ID</th>
                <th>Email</th>
                <th>Program</th>
                <th>Project</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="s : ${students}">
                <td><input type="checkbox" name="studentIds" th:value="${s.id}" class="student-checkbox" /></td>
                <td th:text="${s.name}"></td>
                <td th:text="${s.studentId}"></td>
                <td th:text="${s.email}"></td>
                <td th:text="${s.program}"></td>
                <td th:text="${s.projectTitle}"></td>
            </tr>
            </tbody>
        </table>

        <!-- No server submit required; handled client-side with mailto link -->
    </form>
</div>

<!-- Reminder Modal -->
<div class="modal fade" id="reminderModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Compose Reminder</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <strong id="selectedCount"></strong>
                </div>
                <div class="mb-3">
                    <label for="modalSubject" class="form-label">Subject</label>
                    <input type="text" id="modalSubject" class="form-control" />
                </div>
                <div class="mb-3">
                    <label for="modalBody" class="form-label">Body</label>
                    <textarea id="modalBody" rows="6" class="form-control"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="openEmailClient()">Open Email in Client</button>
            </div>
        </div>
    </div>
</div>

<script>
    function selectAll(flag){
        document.querySelectorAll('.student-checkbox').forEach(cb => cb.checked = !!flag);
    }
    function prepareReminderModal(){
        const coordinatorName = document.getElementById('currentUserName')?.textContent?.trim() || '';
        const selected = Array.from(document.querySelectorAll('.student-checkbox:checked'));
        document.getElementById('selectedCount').textContent = selected.length + ' student(s) selected';
        document.getElementById('modalSubject').value = 'Project Selection Reminder';
        document.getElementById('modalBody').value = 'Hello Students,\n\nThis is a friendly reminder to finalize or select your project if you have not yet done so. Please review available projects and apply as soon as possible.\n\nBest regards,\n' + coordinatorName;
    }
    function openEmailClient(){
        const selected = Array.from(document.querySelectorAll('.student-checkbox:checked'));
        if(selected.length === 0){
            alert('Please select at least one student.');
            return;
        }
        const emails = selected.map(cb => {
            const row = cb.closest('tr');
            return row.querySelector('td:nth-child(4)').textContent.trim();
        });
        const recipients = emails.join(';');
        const subject = encodeURIComponent(document.getElementById('modalSubject').value);
        const body = encodeURIComponent(document.getElementById('modalBody').value);
        const mailtoLink = 'mailto:' + recipients + '?subject=' + subject + '&body=' + body;
        window.location.href = mailtoLink;
    }
</script>
</body>
</html>
